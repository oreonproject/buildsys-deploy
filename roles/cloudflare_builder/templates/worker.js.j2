import { Container } from "cloudflare:workers";

// One DO class per image – wrangler injects them. Names match wrangler.toml.
{% for rel in cloudflare_releases %}
{%   for arch in cloudflare_archs %}
export class Build_{{ arch }}_{{ rel }} extends Container { defaultPort = 8080 }
{%   endfor %}
{% endfor %}

// Map "arch|release" -> DO binding name
const MAP = {
{% for rel in cloudflare_releases %}
{%   for arch in cloudflare_archs %}
  "{{ arch }}|{{ rel }}": "Build_{{ arch }}_{{ rel }}",
{%   endfor %}
{% endfor %}
};

export default {
  async fetch(req, env) {
    const job = await req.json();                       // {arch, oreon, …}
    const key = `${job.arch}|${job.oreon}`;
    const cls = env[MAP[key]];
    const id  = cls.idFromName(String(job.job_id));
    return cls.get(id).fetch("/build", { method:"POST", body: JSON.stringify(job) });
  }
};